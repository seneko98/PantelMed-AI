from typing import Dict, List
from fastapi import HTTPException
from security_agent import SecurityAgent
from subscription_manager import SubscriptionManager
from former_user import FormerUser
from logger_agent import LoggerAgent
import openai
import json

class BloodInterpreter:
    def __init__(self):
        self.security_agent = SecurityAgent()
        self.subscription_manager = SubscriptionManager()
        self.former_user = FormerUser()
        self.logger_agent = LoggerAgent()
        openai.api_key = "your-openai-api-key-here"
        
        # Комплексна база аналізів із blood_interpreter.txt
        self.COMPREHENSIVE_LAB_INTERPRETER = {
            # ===========================================
            # ПЕЧІНКОВІ ПОКАЗНИКИ
            # ===========================================
            "liver_panel": {
                "category": "Печінкові показники",
                "description": "Оцінка функції печінки, детоксикації, жовчовиділення",
                "tests": {
                    "alt": {
                        "name": "АЛТ (аланінамінотрансфераза)",
                        "units": "Од/л",
                        "reference_range": {"min": 0, "max": 40, "optimal": "<25"},
                        "symptom_connections": ["fatigue", "abdominal_pain_right", "bitter_mouth"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 40, "moderate": 80, "severe": 120},
                                "description": "Печінкове запалення (гепатит, токсичне ураження, стероїди)",
                                "causes": [
                                    "Алкогольне ураження",
                                    "Медикаментозне ураження (стероїди, парацетамол)",
                                    "Жирова інфільтрація печінки",
                                    "Вірусні гепатити"
                                ],
                                "immediate_actions": [
                                    "Відміна гепатотоксичних препаратів",
                                    "Виключення алкоголю",
                                    "Консультація гастроентеролога при >2x норми"
                                ],
                                "supplements": [
                                    "NAC 600-1200 мг/день натще",
                                    "TUDCA 250-500 мг після їжі",
                                    "Розторопша 200-400 мг/день",
                                    "Бурштинова кислота 500 мг зранку (обережно при гастриті)"
                                ],
                                "recheck_period": "30-40 днів"
                            }
                        }
                    },
                    "ast": {
                        "name": "АСТ (аспартатамінотрансфераза)",
                        "units": "Од/л",
                        "reference_range": {"min": 0, "max": 40, "optimal": "<20"},
                        "symptom_connections": ["fatigue", "muscle_pain", "yellow_skin"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 40, "moderate": 80, "severe": 120},
                                "description": "Пошкодження печінки або м’язів",
                                "causes": [
                                    "Інтенсивні тренування",
                                    "Стероїди",
                                    "Вірусні гепатити",
                                    "Алкоголь"
                                ],
                                "immediate_actions": [
                                    "Зменшення фізичних навантажень",
                                    "Консультація лікаря при >2x норми"
                                ],
                                "supplements": [
                                    "NAC 600-1200 мг/день",
                                    "TUDCA 250-500 мг після їжі"
                                ],
                                "recheck_period": "30-40 днів"
                            }
                        }
                    },
                    "ggt": {
                        "name": "ГГТ (гамма-глутамілтрансфераза)",
                        "units": "Од/л",
                        "reference_range": {"min": 0, "max": 50, "optimal": "<30"},
                        "symptom_connections": ["fatigue", "abdominal_pain", "alcohol_abuse"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 50, "moderate": 100, "severe": 200},
                                "description": "Пошкодження жовчних шляхів або печінки",
                                "causes": [
                                    "Алкогольне ураження",
                                    "Медикаментозне ураження (стероїди, антибіотики)",
                                    "Холецистит або холестаз",
                                    "Жирова печінка"
                                ],
                                "immediate_actions": [
                                    "Виключення алкоголю",
                                    "Консультація гастроентеролога",
                                    "УЗД печінки та жовчних шляхів"
                                ],
                                "supplements": [
                                    "NAC 600-1200 мг/день",
                                    "TUDCA 250-500 мг після їжі",
                                    "Артишок 400-800 мг/день",
                                    "Холін 500-1000 мг/день"
                                ],
                                "recheck_period": "30-40 днів"
                            }
                        }
                    },
                    "alp": {
                        "name": "Лужна фосфатаза",
                        "units": "Од/л",
                        "reference_range": {"min": 30, "max": 120, "optimal": "<100"},
                        "symptom_connections": ["fatigue", "bone_pain", "yellow_skin"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 120, "moderate": 200, "severe": 300},
                                "description": "Пошкодження жовчних шляхів або кісток",
                                "causes": [
                                    "Холецистит або холестаз",
                                    "Медикаментозне ураження",
                                    "Проблеми з кістками (рахіт, остеопороз)",
                                    "Гепатит"
                                ],
                                "immediate_actions": [
                                    "Консультація гастроентеролога",
                                    "УЗД печінки та жовчних шляхів",
                                    "Перевірка вітаміну D і кальцію"
                                ],
                                "supplements": [
                                    "TUDCA 250-500 мг після їжі",
                                    "Вітамін D3 2000-4000 МО/день",
                                    "Холін 500-1000 мг/день"
                                ],
                                "recheck_period": "30-40 днів"
                            }
                        }
                    },
                    "bilirubin_total": {
                        "name": "Білірубін загальний",
                        "units": "мкмоль/л",
                        "reference_range": {"min": 5, "max": 21, "optimal": "<17"},
                        "symptom_connections": ["yellow_skin", "dark_urine", "fatigue"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 21, "moderate": 40, "severe": 60},
                                "description": "Проблеми з печінкою або жовчними шляхами",
                                "causes": [
                                    "Гепатит",
                                    "Холестаз",
                                    "Медикаментозне ураження",
                                    "Гемоліз"
                                ],
                                "immediate_actions": [
                                    "Консультація гастроентеролога",
                                    "УЗД печінки",
                                    "Виключення алкоголю та токсинів"
                                ],
                                "supplements": [
                                    "TUDCA 250-500 мг після їжі",
                                    "NAC 600-1200 мг/день",
                                    "Артишок 400-800 мг/день"
                                ],
                                "recheck_period": "14-30 днів"
                            }
                        }
                    }
                }
            },
            # ===========================================
            # ГОРМОНАЛЬНІ ПОКАЗНИКИ
            # ===========================================
            "hormone_panel": {
                "category": "Гормональні показники",
                "description": "Оцінка гормонального балансу",
                "tests": {
                    "tsh": {
                        "name": "TSH (тиреотропний гормон)",
                        "units": "мМО/л",
                        "reference_range": {"min": 0.4, "max": 4.0, "optimal": "1-2"},
                        "symptom_connections": ["fatigue", "weight_gain", "cold_intolerance"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 4.0, "moderate": 6.0, "severe": 10.0},
                                "description": "Гіпотиреоз",
                                "causes": [
                                    "Дефіцит йоду",
                                    "Аутоімунне ураження (Хашимото)",
                                    "Медикаментозне ураження"
                                ],
                                "immediate_actions": [
                                    "Консультація ендокринолога",
                                    "Перевірка Т3, Т4, АТ-ТПО"
                                ],
                                "supplements": [
                                    "Селен 200 мкг/день",
                                    "Йод 150 мкг/день (обережно при АТ-ТПО+)",
                                    "L-тирозин 500-1000 мг натще"
                                ],
                                "recheck_period": "60-90 днів"
                            }
                        }
                    },
                    "testosterone_total": {
                        "name": "Тестостерон загальний",
                        "units": "нмоль/л",
                        "reference_range": {"min": 12, "max": 30, "optimal": "15-25"},
                        "symptom_connections": ["low_libido", "fatigue", "erectile_dysfunction"],
                        "interpretation": {
                            "low": {
                                "thresholds": {"mild": 12, "moderate": 8, "severe": 5},
                                "description": "Гіпогонадизм або порушення синтезу",
                                "causes": [
                                    "Стрес",
                                    "Недостатній сон",
                                    "Дефіцит цинку/вітаміну D",
                                    "Порушення осі ГГЯ"
                                ],
                                "immediate_actions": [
                                    "Консультація андролога",
                                    "Перевірка ЛГ, ФСГ, пролактину"
                                ],
                                "supplements": [
                                    "Цинк 30-50 мг/день",
                                    "Вітамін D3 2000-4000 МО/день",
                                    "Ашваганда 600 мг/день"
                                ],
                                "recheck_period": "60-90 днів"
                            }
                        }
                    },
                    "cortisol": {
                        "name": "Кортизол",
                        "units": "нмоль/л",
                        "reference_range": {"min": 138, "max": 690, "optimal": "200-500"},
                        "symptom_connections": ["fatigue", "insomnia", "weight_gain"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 690, "moderate": 800, "severe": 1000},
                                "description": "Хронічний стрес",
                                "causes": [
                                    "Перетренування",
                                    "Поганий сон",
                                    "Стрес",
                                    "Кофеїн/стимулятори"
                                ],
                                "immediate_actions": [
                                    "Консультація ендокринолога",
                                    "Зменшення тренувань"
                                ],
                                "supplements": [
                                    "Ашваганда 600 мг/день",
                                    "Родіола 200-400 мг/день",
                                    "Фосфатидилсерин 100-200 мг перед сном"
                                ],
                                "recheck_period": "30-60 днів"
                            }
                        }
                    },
                    "prolactin": {
                        "name": "Пролактин",
                        "units": "мкг/л",
                        "reference_range": {"min": 2, "max": 25, "optimal": "<15"},
                        "symptom_connections": ["low_libido", "fatigue", "gynecomastia"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 25, "moderate": 50, "severe": 100},
                                "description": "Гіперпролактинемія",
                                "causes": [
                                    "Стрес",
                                    "Гіпотиреоз",
                                    "Медикаменти (антидепресанти, антипсихотики)",
                                    "Пухлина гіпофіза"
                                ],
                                "immediate_actions": [
                                    "Консультація ендокринолога",
                                    "МРТ гіпофіза",
                                    "Перевірка TSH"
                                ],
                                "supplements": [
                                    "Вітамін B6 100-200 мг/день",
                                    "L-допа 500-1000 мг/день",
                                    "Ашваганда 600 мг/день"
                                ],
                                "recheck_period": "30-60 днів"
                            }
                        }
                    },
                    "lh": {
                        "name": "ЛГ (лютеїнізуючий гормон)",
                        "units": "МО/л",
                        "reference_range": {"min": 1.5, "max": 9.3, "optimal": "3-6"},
                        "symptom_connections": ["low_libido", "fatigue", "erectile_dysfunction"],
                        "interpretation": {
                            "low": {
                                "thresholds": {"mild": 1.5, "moderate": 1.0, "severe": 0.5},
                                "description": "Вторинний гіпогонадизм",
                                "causes": [
                                    "Стрес",
                                    "Ожиріння",
                                    "Гіпофізарна недостатність",
                                    "Стероїди"
                                ],
                                "immediate_actions": [
                                    "Консультація андролога",
                                    "Перевірка тестостерону, ФСГ"
                                ],
                                "supplements": [
                                    "Цинк 30-50 мг/день",
                                    "Вітамін D3 2000-4000 МО/день"
                                ],
                                "recheck_period": "60-90 днів"
                            }
                        }
                    },
                    "fsh": {
                        "name": "ФСГ (фолікулостимулюючий гормон)",
                        "units": "МО/л",
                        "reference_range": {"min": 1.4, "max": 18.1, "optimal": "3-10"},
                        "symptom_connections": ["low_libido", "infertility", "fatigue"],
                        "interpretation": {
                            "low": {
                                "thresholds": {"mild": 1.4, "moderate": 1.0, "severe": 0.5},
                                "description": "Порушення репродуктивної функції",
                                "causes": [
                                    "Стероїди",
                                    "Гіпофізарна недостатність",
                                    "Стрес"
                                ],
                                "immediate_actions": [
                                    "Консультація андролога",
                                    "Перевірка тестостерону, ЛГ"
                                ],
                                "supplements": [
                                    "Цинк 30-50 мг/день",
                                    "Вітамін D3 2000-4000 МО/день"
                                ],
                                "recheck_period": "60-90 днів"
                            }
                        }
                    }
                }
            },
            # ===========================================
            # МЕТАБОЛІЧНІ ПОКАЗНИКИ
            # ===========================================
            "metabolic_panel": {
                "category": "Метаболічні показники",
                "description": "Оцінка метаболізму, глюкози, ліпідів",
                "tests": {
                    "glucose": {
                        "name": "Глюкоза натще",
                        "units": "ммоль/л",
                        "reference_range": {"min": 3.3, "max": 5.5, "optimal": "<5.0"},
                        "symptom_connections": ["thirst", "fatigue", "weight_loss"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 5.5, "moderate": 7.0, "severe": 11.0},
                                "description": "Інсулінорезистентність або діабет",
                                "causes": [
                                    "Високовуглеводна дієта",
                                    "Переїдання",
                                    "Мало руху",
                                    "Генетика"
                                ],
                                "immediate_actions": [
                                    "Консультація ендокринолога",
                                    "HbA1c, інсулін"
                                ],
                                "supplements": [
                                    "Берберин 500-1000 мг перед їжею",
                                    "Хром піколінат 200-400 мкг",
                                    "Кориця 1-2 г з їжею"
                                ],
                                "recheck_period": "30-60 днів"
                            }
                        }
                    },
                    "insulin": {
                        "name": "Інсулін натще",
                        "units": "мкОд/мл",
                        "reference_range": {"min": 2, "max": 19, "optimal": "<10"},
                        "symptom_connections": ["hunger", "fatigue", "weight_gain"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 19, "moderate": 25, "severe": 30},
                                "description": "Інсулінорезистентність",
                                "causes": [
                                    "Високовуглеводна дієта",
                                    "Переїдання",
                                    "Мало руху",
                                    "Генетика"
                                ],
                                "immediate_actions": [
                                    "Консультація ендокринолога",
                                    "Глюкоза, HbA1c"
                                ],
                                "supplements": [
                                    "Берберин 500-1000 мг перед їжею",
                                    "Хром піколінат 200-400 мкг",
                                    "Кориця 1-2 г з їжею"
                                ],
                                "recheck_period": "30-60 днів"
                            }
                        }
                    },
                    "hba1c": {
                        "name": "Глікований гемоглобін (HbA1c)",
                        "units": "%",
                        "reference_range": {"min": 4.0, "max": 5.6, "optimal": "<5.4"},
                        "symptom_connections": ["thirst", "fatigue", "weight_loss"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 5.6, "moderate": 6.5, "severe": 7.0},
                                "description": "Предіабет або діабет",
                                "causes": [
                                    "Інсулінорезистентність",
                                    "Високовуглеводна дієта",
                                    "Генетика"
                                ],
                                "immediate_actions": [
                                    "Консультація ендокринолога",
                                    "Перевірка глюкози, інсуліну"
                                ],
                                "supplements": [
                                    "Берберин 500-1000 мг перед їжею",
                                    "Хром піколінат 200-400 мкг",
                                    "Альфа-ліпоєва кислота 300-600 мг/день"
                                ],
                                "recheck_period": "90-120 днів"
                            }
                        }
                    },
                    "cholesterol_total": {
                        "name": "Холестерин загальний",
                        "units": "ммоль/л",
                        "reference_range": {"min": 3.0, "max": 5.2, "optimal": "<4.5"},
                        "symptom_connections": ["fatigue", "chest_pain", "shortness_of_breath"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 5.2, "moderate": 6.2, "severe": 7.0},
                                "description": "Ризик атеросклерозу",
                                "causes": [
                                    "Вევ
                                "Високожирова дієта",
                                    "Мало руху",
                                    "Генетика",
                                    "Стероїди"
                                ],
                                "immediate_actions": [
                                    "Консультація кардіолога",
                                    "Перегляд дієти"
                                ],
                                "supplements": [
                                    "Омега-3 1000-2000 мг/день",
                                    "Коензим Q10 100-200 мг/день",
                                    "Часник 600-1200 мг/день"
                                ],
                                "recheck_period": "90-120 днів"
                            }
                        }
                    },
                    "ldl": {
                        "name": "ЛПНЩ (LDL)",
                        "units": "ммоль/л",
                        "reference_range": {"min": 1.0, "max": 3.0, "optimal": "<2.5"},
                        "symptom_connections": ["chest_pain", "shortness_of_breath"],
                        "interpretation": {
                            "high": {
                                "thresholds": {"mild": 3.0, "moderate": 4.0, "severe": 5.0},
                                "description": "Високий ризик серцево-судинних захворювань",
                                "causes": [
                                    "Високожирова дієта",
                                    "Мало руху",
                                    "Генетика"
                                ],
                                "immediate_actions": [
                                    "Консультація кардіолога",
                                    "Зміна дієти"
                                ],
                                "supplements": [
                                    "Омега-3 1000-2000 мг/день",
                                    "Коензим Q10 100-200 мг/день"
                                ],
                                "recheck_period": "90-120 днів"
                            }
                        }
                    },
                    "hdl": {
                        "name": "ЛПВЩ (HDL)",
                        "units": "ммоль/л",
                        "reference_range": {"min": 1.0, "max": 2.0, "optimal": ">1.5"},
                        "symptom_connections": ["fatigue", "chest_pain"],
                        "interpretation": {
                            "low": {
                                "thresholds": {"mild": 1.0, "moderate": 0.8, "severe": 0.6},
                                "description": "Низький рівень захисту від атеросклерозу",
                                "causes": [
                                    "Мало руху",
                                    "Високовуглеводна дієта",
                                    "Куріння"
                                ],
                                "immediate_actions": [
                                    "Регулярні кардіотренування",
                                    "Консультація кардіолога"
                                ],
                                "supplements": [
                                    "Омега-3 1000-2000 мг/день",
                                    "Ніацин 500-1000 мг/день"
                                ],
                                "recheck_period": "90-120 днів"
                            }
                        }
                    }
                }
            },
            # ===========================================
            # ВІТАМІНИ ТА МІКРОЕЛЕМЕНТИ
            # ===========================================
            "vitamin_mineral_panel": {
                "category": "Вітаміни та мікроелементи",
                "description": "Оцінка рівня вітамінів і мікроелементів",
                "tests": {
                    "vitamin_d": {
                        "name": "Вітамін D (25-OH)",
                        "units": "нг/мл",
                        "reference_range": {"min": 30, "max": 100, "optimal": "40-60"},
                        "symptom_connections": ["fatigue", "bone_pain", "depression"],
                        "interpretation": {
                            "low": {
                                "thresholds": {"mild": 30, "moderate": 20, "severe": 10},
                                "description": "Дефіцит вітаміну D",
                                "causes": [
                                    "Недостатнє перебування на сонці",
                                    "Низьке споживання вітаміну D",
                                    "Порушення всмоктування"
                                ],
                                "immediate_actions": [
                                    "Консультація лікаря",
                                    "Додатковий прийом вітаміну D"
                                ],
                                "supplements": [
                                    "Вітамін D3 2000-5000 МО/день",
                                    "Магній 200-400 мг/день",
                                    "Вітамін K2 100-200 мкг/день"
                                ],
                                "recheck_period": "90-120 днів"
                            }
                        }
                    },
                    "ferritin": {
                        "name": "Феритин",
                        "units": "нг/мл",
                        "reference_range": {"min": 30, "max": 400, "optimal": "50-150"},
                        "symptom_connections": ["fatigue", "hair_loss", "pale_skin"],
                        "interpretation": {
                            "low": {
                                "thresholds": {"mild": 30, "moderate": 20, "severe": 10},
                                "description": "Дефіцит заліза",
                                "causes": [
                                    "Недостатнє споживання заліза",
                                    "Крововтрати",
                                    "Порушення всмоктування"
                                ],
                                "immediate_actions": [
                                    "Консультація гематолога",
                                    "Перевірка заліза, ТЗЗС"
                                ],
                                "supplements": [
                                    "Залізо 18-65 мг/день (з вітаміном С)",
                                    "Вітамін С 500-1000 мг/день"
                                ],
                                "recheck_period": "60-90 днів"
                            }
                        }
                    }
                }
            },
            # ===========================================
            # СИНДРОМИ
            # ===========================================
            "syndromes": {
                "hypothyroid_syndrome": {
                    "criteria": {
                        "tsh_high": "TSH > 4.0",
                        "symptoms": ["fatigue", "weight_gain", "cold_intolerance"]
                    },
                    "interpretation": "Гіпотиреоїдний синдром",
                    "recommendations": [
                        "Консультація ендокринолога",
                        "Селен 200 мкг/день",
                        "Йод 150 мкг/день (обережно при АТ-ТПО+)",
                        "L-тирозин 500-1000 мг натще"
                    ]
                },
                "male_hypogonadism": {
                    "criteria": {
                        "testosterone_low": "testosterone_total < 12",
                        "symptoms": ["low_libido", "fatigue", "erectile_dysfunction"]
                    },
                    "interpretation": "Чоловічий гіпогонадизм",
                    "recommendations": [
                        "Консультація андролога",
                        "УЗД мошонки",
                        "Перевірка ЛГ, ФСГ, пролактину",
                        "Розгляд ГЗТ або стимулюючої терапії"
                    ]
                },
                "insulin_resistance": {
                    "criteria": {
                        "insulin_high": "insulin > 19",
                        "glucose_high": "glucose > 5.5",
                        "symptoms": ["hunger", "fatigue", "weight_gain"]
                    },
                    "interpretation": "Інсулінорезистентність",
                    "recommendations": [
                        "Консультація ендокринолога",
                        "Низьковуглеводна дієта",
                        "Регулярні фізичні навантаження",
                        "Берберин 500-1000 мг перед їжею",
                        "Хром піколінат 200-400 мкг"
                    ]
                },
                "vitamin_d_deficiency": {
                    "criteria": {
                        "vitamin_d_low": "vitamin_d < 30",
                        "symptoms": ["fatigue", "bone_pain", "depression"]
                    },
                    "interpretation": "Дефіцит вітаміну D",
                    "recommendations": [
                        "Консультація лікаря",
                        "Вітамін D3 2000-5000 МО/день",
                        "Магній 200-400 мг/день",
                        "Вітамін K2 100-200 мкг/день"
                    ]
                }
            }
        }

    def interpret_analysis(self, user_id: str, analysis: Dict, symptoms: List[str] = None) -> Dict:
        """Інтерпретує аналіз крові з урахуванням симптомів."""
        self.security_agent.check_user(user_id)
        self.subscription_manager.check_analysis_limit(user_id)

        analysis_type = analysis.get("type")
        value = analysis.get("value")
        date = analysis.get("date")

        if not all([analysis_type, value, date]):
            raise HTTPException(status_code=400, detail="Потрібні type, value, date")

        # Збереження аналізу
        self.former_user.add_analysis(user_id, analysis_type, value, date)

        # Пошук відповідного тесту в базі
        interpretation = {}
        for panel, data in self.COMPREHENSIVE_LAB_INTERPRETER.items():
            if panel == "syndromes":
                continue
            tests = data.get("tests", {})
            if analysis_type.lower() in tests:
                test_info = tests[analysis_type.lower()]
                ref_range = test_info["reference_range"]
                
                # Визначення статусу
                status = "normal"
                if value < ref_range["min"]:
                    status = "low"
                    interpretation = test_info["interpretation"].get("low", {})
                elif value > ref_range["max"]:
                    status = "high"
                    interpretation = test_info["interpretation"].get("high", {})
                
                interpretation.update({
                    "test_name": test_info["name"],
                    "category": data["category"],
                    "status": status,
                    "reference_range": ref_range,
                    "symptom_connections": test_info["symptom_connections"]
                })

        # Перевірка синдромів
        syndromes = []
        user_data = self.former_user.get_user_data(user_id)
        user_symptoms = symptoms or user_data.get("symptoms", [])
        for syndrome, info in self.COMPREHENSIVE_LAB_INTERPRETER["syndromes"].items():
            criteria_met = True
            for key, condition in info["criteria"].items():
                if key.endswith("_high") and analysis_type.lower() == key.replace("_high", "") and value <= float(condition.split(">")[1]):
                    criteria_met = False
                elif key.endswith("_low") and analysis_type.lower() == key.replace("_low", "") and value >= float(condition.split("<")[1]):
                    criteria_met = False
                elif key == "symptoms" and not all(s in user_symptoms for s in condition):
                    criteria_met = False
            if criteria_met:
                syndromes.append({
                    "syndrome": info["interpretation"],
                    "recommendations": info["recommendations"]
                })

        # AI-інтерпретація (як резервна)
        if not interpretation:
            prompt = f"Інтерпретуй аналіз: {analysis_type} = {value} (дата: {date}). Симптоми: {user_symptoms}. Дай рекомендації."
            response = openai.Completion.create(
                engine="text-davinci-003",
                prompt=prompt,
                max_tokens=500
            ).choices[0].text.strip()
            interpretation = {"ai_interpretation": response}

        # Збереження рекомендацій
        self.former_user.update_user_data(user_id, {
            "analysis_interpretations": user_data.get("analysis_interpretations", []) + [{
                "analysis": {"type": analysis_type, "value": value, "date": date},
                "interpretation": interpretation,
                "syndromes": syndromes
            }]
        })

        self.logger_agent.log_request(user_id, "interpret_analysis", self.logger_agent.token_usage_per_request)
        return {
            "analysis": {"type": analysis_type, "value": value, "date": date},
            "interpretation": interpretation,
            "syndromes": syndromes
        }
