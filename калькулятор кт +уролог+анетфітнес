import math
from enum import Enum
from typing import List, Dict, Optional
from dataclasses import dataclass

# ==============================================================================
# 1. DATABASE LAYER & CONSTANTS (–ë–∞–∑–∞ –∑–Ω–∞–Ω—å)
# ==============================================================================

class DrugType(Enum):
    ORAL = "oral"
    INJECTABLE = "injectable"
    SARM = "sarm"
    SUPPORT = "support"

@dataclass
class DrugProfile:
    name: str
    gold_dose: float
    # scores: [Neuro, Metab, Recov, Safety]
    scores: List[float] 
    half_life: float
    type: DrugType

# –ë–∞–∑–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ñ–≤ (–°–∫–æ—Ä–æ—á–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è –∑ —Ç–≤–æ–≥–æ —Ñ–∞–π–ª—É)
DRUG_DATABASE = {
    "test_e": DrugProfile("Testosterone Enanthate", 500, [6, 5, 8, 9], 5.0, DrugType.INJECTABLE),
    "tren_a": DrugProfile("Trenbolone Acetate", 300, [10, 9, 6, 4], 1.0, DrugType.INJECTABLE),
    "masteron": DrugProfile("Masteron", 400, [7, 6, 6, 8], 3.0, DrugType.INJECTABLE),
    "stanozolol": DrugProfile("Stanozolol", 30, [7, 7, 5, 2], 0.8, DrugType.ORAL), # Low Safety!
    "oxandrolone": DrugProfile("Oxandrolone", 40, [5, 6, 5, 5], 0.4, DrugType.ORAL)
}

# ==============================================================================
# 2. DATA MODELS (–°—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–∞–Ω–∏—Ö / –ü–∞—Å–ø–æ—Ä—Ç)
# ==============================================================================

@dataclass
class HormonalContext:
    """–í–∏—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ –≤—ñ–¥ –£—Ä–æ–ª–æ–≥–∞ –¥–ª—è —ñ–Ω—à–∏—Ö –∞–≥–µ–Ω—Ç—ñ–≤"""
    is_on_cycle: bool
    asg_score: Dict[str, float] # {neuro, metab, recov, safety}
    joint_warning: bool         # True, —è–∫—â–æ —î —Å—É—Ö—ñ –ø—Ä–µ–ø–∏ (–°—Ç–∞–Ω)
    blood_viscosity_alert: bool # True, —è–∫—â–æ —î –ë–æ–ª–¥–µ–Ω–æ–Ω –∞–±–æ –≤–∏—Å–æ–∫–∏–π –≥–µ–º–∞—Ç–æ–∫—Ä–∏—Ç

@dataclass
class AthletePassport:
    weight: float
    height: float
    age_chronological: int
    age_biological: int
    mq_level: float         # 0.0 - 3.0 (Muscle IQ)
    weak_points: List[str]  # ["Chest", "Triceps"]
    injuries: List[str]     # ["Left_Elbow"]
    job_type: str           # "Active", "Office"
    avg_steps: int
    
# ==============================================================================
# 3. UROLOGY ENGINE (–ì–æ—Ä–º–æ–Ω–∞–ª—å–Ω–µ –Ø–¥—Ä–æ)
# ==============================================================================

class UrologyEngine:
    def __init__(self, current_stack: List[Dict]):
        # stack example: [{'name': 'test_e', 'dose': 500, 'week': 4}]
        self.stack = current_stack

    def analyze_status(self) -> HormonalContext:
        if not self.stack:
            return HormonalContext(False, {"neuro": 1, "metab": 1, "recov": 1, "safety": 10}, False, False)

        asg_total = {"neuro": 0.0, "metab": 0.0, "recov": 0.0, "safety": 10.0}
        joint_risk_counter = 0
        
        for item in self.stack:
            drug = DRUG_DATABASE.get(item['name'])
            if not drug: continue
            
            # 1. ESC (Ester Saturation Coefficient) - —Å–ø—Ä–æ—â–µ–Ω–æ
            esc = 1.0 if drug.type == DrugType.ORAL else min(1.0, 0.25 * item['week'])
            
            # 2. Dose Factor
            k_dose = item['dose'] / drug.gold_dose
            
            # 3. Summing Scores
            asg_total["neuro"] += drug.scores["neuro"] * k_dose * esc
            asg_total["metab"] += drug.scores["metab"] * k_dose * esc
            asg_total["recov"] += drug.scores["recov"] * k_dose * esc
            
            # Safety –ø—Ä–∞—Ü—é—î –Ω–∞ –≤—ñ–¥–Ω—ñ–º–∞–Ω–Ω—è
            safety_penalty = (10 - drug.scores["safety"]) * k_dose * esc
            asg_total["safety"] -= safety_penalty

            # Specific Flags
            if drug.name == "Stanozolol" or drug.name == "Masteron":
                joint_risk_counter += 1

        # –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è Safety (–Ω–µ –Ω–∏–∂—á–µ 0)
        asg_total["safety"] = max(0.0, asg_total["safety"])
        
        return HormonalContext(
            is_on_cycle=True,
            asg_score=asg_total,
            joint_warning=(joint_risk_counter > 0 or asg_total["safety"] < 5),
            blood_viscosity_alert=False # –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –¥–ª—è –ë–æ–ª–¥–µ–Ω–æ–Ω–∞
        )

# ==============================================================================
# 4. KT CALCULATOR (–¢—Ä–∏–≤–∏–º—ñ—Ä–Ω–∏–π —Ç–µ—Å—Ç)
# ==============================================================================

class KTCalculator:
    def __init__(self, passport: AthletePassport):
        self.p = passport

    def calculate_hybrid_kt(self, performance: Dict) -> float:
        """
        performance = {
            'bench_1rm': 120, 'squat_1rm': 160, 'deadlift_1rm': 200,
            'lunges_dumbbell': 32, 'strict_curl': 50,
            'pullups': 25, 'dips': 40,
            'recovery_speed': 'High'
        }
        """
        # 1. –°–∏–ª–æ–≤–∏–π –í–µ–∫—Ç–æ—Ä (Relative Strength)
        bw = self.p.weight
        k_str = (
            (performance['bench_1rm'] / bw / 1.3) + 
            (performance['squat_1rm'] / bw / 1.6) + 
            (performance['deadlift_1rm'] / bw / 2.0)
        ) / 3
        k_str = min(1.0, k_str)

        # 2. –ê—Ç–ª–µ—Ç–∏—á–Ω–∏–π –í–µ–∫—Ç–æ—Ä
        # –í–∏–ø–∞–¥–∏ 40–∫–≥ = 1.0. –°—Ç—Ä–æ–≥–∏–π –ø—ñ–¥–π–æ–º 50–∫–≥ = 1.0 (–¥–ª—è –≤–∞–≥–∏ ~85-90)
        k_athl = (
            (performance['lunges_dumbbell'] / 40.0) + 
            (performance['strict_curl'] / 50.0)
        ) / 2
        
        # 3. –ì—ñ–º–Ω–∞—Å—Ç–∏–∫–∞ (Bodyweight)
        k_cali = (
            (performance['pullups'] / 25.0) + 
            (performance['dips'] / 40.0)
        ) / 2

        # 4. –î–≤–∏–≥—É–Ω (–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è)
        rec_map = {"Low": 0.4, "Medium": 0.7, "High": 1.0, "Elite": 1.2}
        k_engine = rec_map.get(performance['recovery_speed'], 0.5)

        # –§—ñ–Ω–∞–ª—å–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ (–ó–≤–∞–∂–µ–Ω–∞)
        # –°–∏–ª–∞ 30%, –ê—Ç–ª–µ—Ç–∏–∑–º 25%, –ì—ñ–º–Ω–∞—Å—Ç–∏–∫–∞ 15%, –î–≤–∏–≥—É–Ω 30%
        final_kt = (k_str * 0.30) + (k_athl * 0.25) + (k_cali * 0.15) + (k_engine * 0.30)
        
        return round(final_kt, 2)

# ==============================================================================
# 5. FITNESS AGENT (Anti-Lie & Logic)
# ==============================================================================

class FitnessAgent:
    def __init__(self, passport: AthletePassport, kt_level: float):
        self.passport = passport
        self.kt = kt_level

    def generate_session_params(self, day: str, h_context: HormonalContext, sleep_score: int):
        print(f"\n--- –ê–ù–ê–õ–Ü–ó –§–Ü–¢–ù–ï–°-–ê–ì–ï–ù–¢–ê ({day}) ---")
        
        # 1. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ RR (Real Readiness)
        # –ë–∞–∑–∞ = –°–æ–Ω + –ö–¢
        rr_base = (sleep_score / 10.0) * 0.5 + (self.kt * 0.5)
        
        # –ë–æ–Ω—É—Å –≤—ñ–¥ —Ñ–∞—Ä–º–∏ (Global Recovery)
        # –Ø–∫—â–æ ASG Recov = 8 (–≤–∏—Å–æ–∫–∏–π), –¥–∞—î–º–æ –±–æ–Ω—É—Å +30% –¥–æ RR
        pharma_bonus = h_context.asg_score["recov"] * 0.04
        
        # –®—Ç—Ä–∞—Ñ –∑–∞ –∫—Ä–æ–∫–∏ (Habituation)
        steps_tax = 0.0
        if self.passport.job_type == "Active" and self.passport.avg_steps > 15000:
            steps_tax = 0.1 # -10% —Ä–µ—Å—É—Ä—Å—É
        
        final_rr = rr_base + pharma_bonus - steps_tax
        print(f"üìä RR (–ë–µ–Ω–∑–æ–±–∞–∫): {final_rr:.2f} (–ë–∞–∑–∞: {rr_base:.2f} + –§–∞—Ä–º–∞: {pharma_bonus:.2f})")

        # 2. –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—ñ–≤ (Monday Logic)
        focus_group = "Planned Split"
        if day == "Monday" and self.passport.weak_points:
            focus_group = f"WEAK POINT PRIORITY: {self.passport.weak_points[0].upper()}"
            print(f"‚ö†Ô∏è –í–∏—è–≤–ª–µ–Ω–æ '–ü–æ–Ω–µ–¥—ñ–ª–æ–∫'. –ê–∫—Ç–∏–≤—É—î–º–æ –ø—Ä–æ—Ç–æ–∫–æ–ª —Å–ª–∞–±–∫–æ—ó –ª–∞–Ω–∫–∏: {focus_group}")

        # 3. Joint Safety Filter (–°—Ç–∞–Ω–æ–∑–æ–ª–æ–ª / –¢—Ä–∞–≤–º–∏)
        safety_mode = "Normal"
        restrictions = []
        
        if h_context.joint_warning:
            safety_mode = "JOINT PROTECTION ACTIVE"
            restrictions.append("No explosive movements")
            restrictions.append("No heavy low-rep sets (<6 reps)")
            restrictions.append("Extended Warmup (+15 min)")
            
            # –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏–π –±–∞–Ω –¥–ª—è —Ö–≤–æ—Ä–∏—Ö –º—ñ—Å—Ü—å
            if "Left_Elbow" in self.passport.injuries:
                restrictions.append("BAN: French Press, Heavy Bench Lockouts")
        
        # 4. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ RPE (–Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—ñ) –Ω–∞ –æ—Å–Ω–æ–≤—ñ Neuro Drive
        neuro = h_context.asg_score["neuro"]
        if neuro > 7 and final_rr > 0.7:
            rpe = "9-10 (Failure allowed, Drop-sets allowed)"
        elif neuro > 4:
            rpe = "7-8 (2 reps in reserve)"
        else:
            rpe = "5-6 (Deload / Pump mode)"

        # 5. Volume (Sets) - MQ Scaling
        # –ë–∞–∑–∞ –¥–ª—è –ö–¢ 0.8 = 16 —Å–µ—Ç—ñ–≤. MQ –º–Ω–æ–∂–Ω–∏–∫.
        base_volume = 12 + (self.kt * 5) # 12 + 4 = 16
        if self.passport.mq_level >= 2.0: # High MQ
            # –ü—Ä–æ—Ñ—ñ —Ä–æ–±–∏—Ç—å –º–µ–Ω—à–µ —Å–º—ñ—Ç—Ç—î–≤–æ–≥–æ –æ–±'—î–º—É, –∞–ª–µ —è–∫—ñ—Å–Ω—ñ—à–µ
            final_sets = int(base_volume * 1.0) 
        else:
            # –ù–æ–≤–∞—á–æ–∫ –±–µ—Ä–µ –∫—ñ–ª—å–∫—ñ—Å—Ç—é
            final_sets = int(base_volume * 1.2)
            
        # –ö–æ—Ä–µ–∫—Ü—ñ—è –Ω–∞ ASG
        if h_context.asg_score["recov"] > 5:
            final_sets += 4 # –§–∞—Ä–º–∞ –¥–æ–∑–≤–æ–ª—è—î –±—ñ–ª—å—à–µ

        return {
            "Day": day,
            "Focus": focus_group,
            "Readiness_RR": f"{final_rr*100:.0f}%",
            "Safety_Mode": safety_mode,
            "Restrictions": restrictions,
            "Target_RPE": rpe,
            "Working_Sets_Total": final_sets,
            "Neuro_Drive_Status": f"{neuro:.1f}/10"
        }

# ==============================================================================
# 6. SIMULATION (–¢–µ—Å—Ç–æ–≤–∏–π –∑–∞–ø—É—Å–∫)
# ==============================================================================

# 1. –°—Ç–≤–æ—Ä—é—î–º–æ –ø–∞—Å–ø–æ—Ä—Ç (–ì—ñ–±—Ä–∏–¥, —è–∫ —Ç–∏)
user_passport = AthletePassport(
    weight=88.0, height=178.0, 
    age_chronological=34, age_biological=28,
    mq_level=2.5, # High MQ (Expert)
    weak_points=["Upper_Chest"],
    injuries=["Left_Elbow"],
    job_type="Active", avg_steps=12000
)

# 2. –ü—Ä–æ–≥–∞–Ω—è—î–º–æ "–ü–æ—Ç—Ä—ñ–π–Ω–∏–π —Ç–µ—Å—Ç"
kt_calc = KTCalculator(user_passport)
user_performance = {
    'bench_1rm': 140, 'squat_1rm': 180, 'deadlift_1rm': 220, # –°–∏–ª–∞
    'lunges_dumbbell': 40, 'strict_curl': 55,               # –ê—Ç–ª–µ—Ç–∏–∑–º
    'pullups': 28, 'dips': 50,                              # –ì—ñ–º–Ω–∞—Å—Ç–∏–∫–∞
    'recovery_speed': 'Elite'                               # –î–≤–∏–≥—É–Ω
}
user_kt = kt_calc.calculate_hybrid_kt(user_performance)
print(f"üß¨ CALCULATED KT LEVEL: {user_kt} (Expert Level)")

# 3. –ó–∞–ø—É—Å–∫–∞—î–º–æ –£—Ä–æ–ª–æ–≥–∞ (–°—Ç–µ–∫: –¢–µ—Å—Ç + –°—Ç–∞–Ω + –¢—Ä–µ–Ω)
# –¢–∏–∂–¥–µ–Ω—å 3 - –ø—ñ–∫ –æ—Ä–∞–ª–æ–∫, —Ä–æ–∑–≥—ñ–Ω –µ—Ñ—ñ—Ä—ñ–≤
current_stack = [
    {'name': 'test_e', 'dose': 500, 'week': 3},
    {'name': 'tren_a', 'dose': 200, 'week': 3},
    {'name': 'stanozolol', 'dose': 30, 'week': 3} 
]
urologist = UrologyEngine(current_stack)
hormonal_ctx = urologist.analyze_status()
print(f"üíä PHARMA STATUS: ASG={hormonal_ctx.asg_score}, Joint_Warn={hormonal_ctx.joint_warning}")

# 4. –§—ñ—Ç–Ω–µ—Å –ê–≥–µ–Ω—Ç –≥–µ–Ω–µ—Ä—É—î —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –Ω–∞ –ü–æ–Ω–µ–¥—ñ–ª–æ–∫
agent = FitnessAgent(user_passport, user_kt)
# –°–∏–º—É–ª—è—Ü—ñ—è: –ü–æ–Ω–µ–¥—ñ–ª–æ–∫, —Å–æ–Ω –±—É–≤ —Å–µ—Ä–µ–¥–Ω—ñ–π (7/10)
session = agent.generate_session_params("Monday", hormonal_ctx, sleep_score=7)

print("\n--- FINAL TRAINING PROTOCOL ---")
for k, v in session.items():
    print(f"{k}: {v}")
