# assistant/steroids/questionnaire.py
"""
PantelMed AI - –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∫–µ—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –ø—ñ–¥–±–æ—Ä—É –∫—É—Ä—Å—ñ–≤
–í—Å—ñ –∫–æ—Ä–µ–∫—Ç–∏–≤–∏: –≥—ñ–ø–µ—Ä—Ç–æ–Ω—ñ—è, —ñ–Ω'—î–∫—Ü—ñ—ó, –∞–Ω–∞–ª—ñ–∑–∏, –±–µ–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—ñ
"""

from typing import Dict, List, Optional, Tuple
from dataclasses import dataclass
from enum import Enum

class QuestionType(Enum):
    SELECT = "select"
    MULTIPLE_SELECT = "multiple_select"
    SCALE = "scale"
    TEXT = "text"

@dataclass
class QuestionOption:
    value: str
    label: str
    score: int = 0
    restrictions: List[str] = None
    warnings: List[str] = None
    follow_up: str = None

@dataclass
class Question:
    id: str
    text: str
    type: QuestionType
    required: bool = True
    options: List[QuestionOption] = None
    validation: Dict = None
    conditional_logic: Dict = None

class SteroidQuestionnaire:
    """–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∫–µ—Ç—É–≤–∞–Ω–Ω—è –∑ —É—Å—ñ–º–∞ –∫–æ—Ä–µ–∫—Ç–∏–≤–∞–º–∏"""
    
    def __init__(self):
        self.questions = self._build_questionnaire()
        self.total_questions = len(self.questions)
        self.question_flow = self._build_question_flow()
    
    def _build_questionnaire(self) -> Dict[str, Question]:
        """–ü–æ–±—É–¥–æ–≤–∞ –∞–Ω–∫–µ—Ç–∏ –∑ –∫–æ—Ä–µ–∫—Ç–∏–≤–∞–º–∏"""
        
        questions = {}
        
        # ===========================================
        # –û–°–û–ë–ò–°–¢–Ü –î–ê–ù–Ü
        # ===========================================
        
        questions["age"] = Question(
            id="age",
            text="–í–∞—à –≤—ñ–∫?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("18-20", "18-20 —Ä–æ–∫—ñ–≤", score=1, 
                             restrictions=["minimal_doses"], 
                             warnings=["–ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–π —Ä–æ–∑–≤–∏—Ç–æ–∫ –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏"]),
                QuestionOption("21-25", "21-25 —Ä–æ–∫—ñ–≤", score=2, 
                             restrictions=["beginner_doses"]),
                QuestionOption("26-35", "26-35 —Ä–æ–∫—ñ–≤", score=3),
                QuestionOption("36-40", "36-40 —Ä–æ–∫—ñ–≤", score=2, 
                             restrictions=["careful_doses"]),
                QuestionOption("40+", "40+ —Ä–æ–∫—ñ–≤", score=1, 
                             restrictions=["special_protocols", "atherosclerosis_check"],
                             warnings=["–ü–æ—Ç—Ä—ñ–±–µ–Ω –ø–æ—Å–∏–ª–µ–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥"])
            ]
        )
        
        questions["weight"] = Question(
            id="weight",
            text="–í–∞—à–∞ –≤–∞–≥–∞?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("<60", "–ú–µ–Ω—à–µ 60 –∫–≥", score=1),
                QuestionOption("60-70", "60-70 –∫–≥", score=2),
                QuestionOption("71-85", "71-85 –∫–≥", score=3),
                QuestionOption("86-100", "86-100 –∫–≥", score=3),
                QuestionOption(">100", "–ü–æ–Ω–∞–¥ 100 –∫–≥", score=3)
            ]
        )
        
        questions["height"] = Question(
            id="height", 
            text="–í–∞—à –∑—Ä—ñ—Å—Ç?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("<170", "–ú–µ–Ω—à–µ 170 —Å–º", score=2),
                QuestionOption("170-180", "170-180 —Å–º", score=3),
                QuestionOption("181-190", "181-190 —Å–º", score=3),
                QuestionOption(">190", "–ü–æ–Ω–∞–¥ 190 —Å–º", score=3)
            ]
        )
        
        # ===========================================
        # –î–û–°–í–Ü–î
        # ===========================================
        
        questions["cycle_count"] = Question(
            id="cycle_count",
            text="–°–∫—ñ–ª—å–∫–∏ –∫—É—Ä—Å—ñ–≤ –≤–∏ –≤–∂–µ —Ä–æ–±–∏–ª–∏?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("0", "0 (–ø–µ—Ä—à–∏–π –∫—É—Ä—Å)", score=1),
                QuestionOption("1-2", "1-2 –∫—É—Ä—Å–∏", score=2),
                QuestionOption("3-5", "3-5 –∫—É—Ä—Å—ñ–≤", score=3),
                QuestionOption(">5", "–ë—ñ–ª—å—à–µ 5 –∫—É—Ä—Å—ñ–≤", score=4)
            ]
        )
        
        questions["previous_compounds"] = Question(
            id="previous_compounds",
            text="–Ø–∫—ñ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∏ –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏? (–º–æ–∂–Ω–∞ –∫—ñ–ª—å–∫–∞)",
            type=QuestionType.MULTIPLE_SELECT,
            required=False,
            conditional_logic={"show_if": {"cycle_count": ["1-2", "3-5", ">5"]}},
            options=[
                QuestionOption("testosterone", "–¢—ñ–ª—å–∫–∏ —Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω"),
                QuestionOption("oral_mild", "–¢–µ—Å—Ç + —Ç–∞–±–ª–µ—Ç–∫–∏ (–æ–∫—Å–∞–Ω, —Ç—É—Ä—ñ–Ω)"),
                QuestionOption("injectable_mild", "–¢–µ—Å—Ç + —ñ–Ω'—î–∫—Ü—ñ–π–Ω—ñ (–º–∞—Å—Ç–µ—Ä–æ–Ω, –ø—Ä—ñ–º–æ)"),
                QuestionOption("complex", "–°–∫–ª–∞–¥–Ω—ñ –∫—É—Ä—Å–∏ (–±–æ–ª–¥–µ–Ω–æ–Ω, –¥–µ–∫–∞)"),
                QuestionOption("hardcore", "–ñ–æ—Ä—Å—Ç–∫—ñ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∏ (—Ç—Ä–µ–Ω–±–æ–ª–æ–Ω, —Ö–∞–ª–æ—Ç–µ—Å—Ç—ñ–Ω)")
            ]
        )
        
        # ===========================================
        # –ú–ï–î–ò–ß–ù–Ü –û–ë–ú–ï–ñ–ï–ù–ù–Ø
        # ===========================================
        
        questions["alopecia"] = Question(
            id="alopecia",
            text="–ß–∏ —î –ø—Ä–æ–±–ª–µ–º–∏ –∑ –≤–∏–ø–∞–¥—ñ–Ω–Ω—è–º –≤–æ–ª–æ—Å—Å—è?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("none", "–ù—ñ, –≥—É—Å—Ç–µ –≤–æ–ª–æ—Å—Å—è", score=3),
                QuestionOption("mild", "–õ–µ–≥–∫–µ –ø–æ—Ä–µ–¥—ñ–Ω–Ω—è", score=2, 
                             restrictions=["dht_microdoses_only"]),
                QuestionOption("active", "–ê–∫—Ç–∏–≤–Ω–∞ –∞–ª–æ–ø–µ—Ü—ñ—è", score=0, 
                             restrictions=["exclude_all_dht"],
                             warnings=["–î–ì–¢ –ø–æ—Ö—ñ–¥–Ω—ñ –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ"]),
                QuestionOption("genetic", "–ì–µ–Ω–µ—Ç–∏—á–Ω–∞ —Å—Ö–∏–ª—å–Ω—ñ—Å—Ç—å –≤ —Ä–æ–¥–∏–Ω—ñ", score=1,
                             restrictions=["dht_caution"])
            ]
        )
        
        questions["prostate"] = Question(
            id="prostate",
            text="–ß–∏ —î –ø—Ä–æ–±–ª–µ–º–∏ –∑ –ø–µ—Ä–µ–¥–º—ñ—Ö—É—Ä–æ–≤–æ—é –∑–∞–ª–æ–∑–æ—é?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("healthy", "–ù—ñ, –≤—Å–µ –¥–æ–±—Ä–µ", score=3),
                QuestionOption("mild", "–õ–µ–≥–∫—ñ –ø—Ä–æ–±–ª–µ–º–∏ (–Ω—ñ—á–Ω—ñ –ø–æ—Ö–æ–¥–∏ –≤ —Ç—É–∞–ª–µ—Ç)", score=2,
                             restrictions=["dht_caution"]),
                QuestionOption("diagnosed", "–î—ñ–∞–≥–Ω–æ—Å—Ç–æ–≤–∞–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏", score=0,
                             restrictions=["exclude_all_dht"],
                             warnings=["–î–ì–¢ –ø–æ—Ö—ñ–¥–Ω—ñ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ"])
            ]
        )
        
        questions["liver"] = Question(
            id="liver",
            text="–°—Ç–∞–Ω –ø–µ—á—ñ–Ω–∫–∏?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("healthy", "–ó–¥–æ—Ä–æ–≤–∞ –ø–µ—á—ñ–Ω–∫–∞", score=3),
                QuestionOption("elevated", "–ü—ñ–¥–≤–∏—â–µ–Ω—ñ –ê–õ–¢/–ê–°–¢", score=2,
                             restrictions=["limit_orals"]),
                QuestionOption("problems", "–ü—Ä–æ–±–ª–µ–º–∏ –∑ –ø–µ—á—ñ–Ω–∫–æ—é", score=0,
                             restrictions=["injectable_only"],
                             warnings=["–¢—ñ–ª—å–∫–∏ —ñ–Ω'—î–∫—Ü—ñ–π–Ω—ñ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∏"]),
                QuestionOption("no_tests", "–ù–µ –∑–¥–∞–≤–∞–≤ –∞–Ω–∞–ª—ñ–∑–∏", score=1,
                             restrictions=["require_tests"],
                             warnings=["–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∑–¥–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑–∏ –ø–µ—á—ñ–Ω–∫–∏"])
            ]
        )
        
        questions["joints"] = Question(
            id="joints",
            text="–ß–∏ —î –ø—Ä–æ–±–ª–µ–º–∏ –∑ —Å—É–≥–ª–æ–±–∞–º–∏?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("healthy", "–ù—ñ", score=3),
                QuestionOption("old_injuries", "–°—Ç–∞—Ä—ñ —Ç—Ä–∞–≤–º–∏", score=2,
                             restrictions=["stanozolol_caution"]),
                QuestionOption("active_problems", "–ê–∫—Ç–∏–≤–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏", score=0,
                             restrictions=["exclude_stanozolol"],
                             warnings=["–°—Ç–∞–Ω–æ–∑–æ–ª–æ–ª –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–∏–π"])
            ]
        )
        
        # –ö–û–†–ï–ö–¢–ò–í–ò: –ì—ñ–ø–µ—Ä—Ç–æ–Ω—ñ—è –∑ –Ω–æ–≤–∏–º –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º
        questions["blood_pressure"] = Question(
            id="blood_pressure",
            text="–Ø–∫–∏–π —É –≤–∞—Å –∞—Ä—Ç–µ—Ä—ñ–∞–ª—å–Ω–∏–π —Ç–∏—Å–∫?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("normal", "–ù–æ—Ä–º–∞–ª—å–Ω–∏–π (120/80)", score=3),
                QuestionOption("slightly_high", "–¢—Ä–æ—Ö–∏ –ø—ñ–¥–≤–∏—â–µ–Ω–∏–π (130-140/90)", score=2,
                             restrictions=["bp_monitoring"]),
                QuestionOption("hypertension", "–ì—ñ–ø–µ—Ä—Ç–æ–Ω—ñ—è", score=1,
                             restrictions=["reduced_doses", "bp_control_mandatory"],
                             warnings=[
                                 "‚ö†Ô∏è –û–ë–û–í'–Ø–ó–ö–û–í–û:",
                                 "‚Ä¢ –°–∞—Ä—Ç–∞–Ω–∏ (–∑–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è–º –ª—ñ–∫–∞—Ä—è)",
                                 "‚Ä¢ –ú–∞–≥–Ω—ñ–π 400–º–≥ –Ω–∞ –¥–µ–Ω—å", 
                                 "‚Ä¢ –¢–∞–¥–∞–ª–∞—Ñ—ñ–ª 5-10–º–≥ –Ω–∞ –Ω—ñ—á (–û–ë–ï–†–ï–ñ–ù–û - –º–æ–∂–µ –æ–±–≤–∞–ª–∏—Ç–∏ —Ç–∏—Å–∫)",
                                 "‚Ä¢ –©–æ–¥–µ–Ω–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∏—Å–∫—É –≤—Ä–∞–Ω—Ü—ñ —Ç–∞ –≤–≤–µ—á–µ—Ä—ñ"
                             ])
            ]
        )
        
        # –ö–û–†–ï–ö–¢–ò–í–ò: –ê—Ç–µ—Ä–æ—Å–∫–ª–µ—Ä–æ–∑ –¥–ª—è 38+
        questions["atherosclerosis"] = Question(
            id="atherosclerosis",
            text="–ß–∏ —î –ø—ñ–¥–æ–∑—Ä–∞ –Ω–∞ –∞—Ç–µ—Ä–æ—Å–∫–ª–µ—Ä–æ–∑? (–¥–ª—è 38+)",
            type=QuestionType.SELECT,
            conditional_logic={"show_if": {"age": ["36-40", "40+"]}},
            options=[
                QuestionOption("no_risk", "–ù–µ–º–∞—î –ø—ñ–¥–æ–∑—Ä–∏", score=3),
                QuestionOption("suspected", "–Ñ –ø—ñ–¥–æ–∑—Ä–∞ –Ω–∞ –∞—Ç–µ—Ä–æ—Å–∫–ª–µ—Ä–æ–∑", score=0,
                             restrictions=["no_orals_strictly", "no_high_test_doses", "consultation_mandatory"],
                             warnings=[
                                 "‚ùå –°–£–í–û–†–û –ó–ê–ë–û–†–û–ù–ï–ù–û:",
                                 "‚Ä¢ –í—Å—ñ —Ç–∞–±–ª–µ—Ç–∫–∏",
                                 "‚Ä¢ –í–∏—Å–æ–∫—ñ –¥–æ–∑–∏ —Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω—É",
                                 "‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 250–º–≥ —Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω—É",
                                 "‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –∫–∞—Ä–¥—ñ–æ–ª–æ–≥–∞ –û–ë–û–í'–Ø–ó–ö–û–í–ê"
                             ])
            ]
        )
        
        # ===========================================
        # –¶–Ü–õ–Ü –¢–ê –ü–ê–†–ê–ú–ï–¢–†–ò –ö–£–†–°–£
        # ===========================================
        
        questions["main_goal"] = Question(
            id="main_goal",
            text="–Ø–∫–∞ –≤–∞—à–∞ –≥–æ–ª–æ–≤–Ω–∞ —Ü—ñ–ª—å?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("mass_gain", "–ù–∞–±—ñ—Ä –º'—è–∑–æ–≤–æ—ó –º–∞—Å–∏"),
                QuestionOption("cutting", "–°—É—à–∫–∞/—Ä–µ–ª—å—î—Ñ"),
                QuestionOption("recomposition", "–†–µ–∫–æ–º–ø–æ–∑–∏—Ü—ñ—è"),
                QuestionOption("competition_prep", "–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –∑–º–∞–≥–∞–Ω—å"),
                QuestionOption("strength", "–ó–±—ñ–ª—å—à–µ–Ω–Ω—è —Å–∏–ª–∏"),
                QuestionOption("sports_performance", "–°–ø–æ—Ä—Ç–∏–≤–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏")
            ]
        )
        
        questions["sport_type"] = Question(
            id="sport_type",
            text="–í–∞—à –≤–∏–¥ —Å–ø–æ—Ä—Ç—É?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("bodybuilding", "–ë–æ–¥—ñ–±—ñ–ª–¥–∏–Ω–≥"),
                QuestionOption("powerlifting", "–ü–∞—É–µ—Ä–ª—ñ—Ñ—Ç–∏–Ω–≥/—Å–∏–ª–æ–≤–∏–π –µ–∫—Å—Ç—Ä—ñ–º"),
                QuestionOption("martial_arts", "–Ñ–¥–∏–Ω–æ–±–æ—Ä—Å—Ç–≤–∞ (–ú–ú–ê, –±–æ–∫—Å, –≥—Ä–µ–ø–ø–ª—ñ–Ω–≥)"),
                QuestionOption("athletics", "–õ–µ–≥–∫–∞ –∞—Ç–ª–µ—Ç–∏–∫–∞ (—Å–ø—Ä–∏–Ω—Ç, —Å—Ç—Ä–∏–±–∫–∏)"),
                QuestionOption("team_sports", "–ö–æ–º–∞–Ω–¥–Ω—ñ –≤–∏–¥–∏ —Å–ø–æ—Ä—Ç—É"),
                QuestionOption("fitness", "–§—ñ—Ç–Ω–µ—Å/–∞–º–∞—Ç–æ—Ä—Å—å–∫—ñ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è")
            ]
        )
        
        questions["duration"] = Question(
            id="duration",
            text="–Ø–∫—É —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –∫—É—Ä—Å—É –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("4_weeks", "4 —Ç–∏–∂–Ω—ñ (—à–≤–∏–¥–∫–∏–π –µ—Ñ–µ–∫—Ç)",
                             warnings=["–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –í–ò–ö–õ–Æ–ß–ù–û –¥–ª—è —Å–ø–æ—Ä—Ç–∏–≤–Ω–∏—Ö –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤, –Ω–µ –¥–ª—è —Ä–æ—Å—Ç—É –º'—è–∑—ñ–≤"]),
                QuestionOption("8_weeks", "8 —Ç–∏–∂–Ω—ñ–≤ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)"),
                QuestionOption("10-12_weeks", "10-12 —Ç–∏–∂–Ω—ñ–≤ (–æ–ø—Ç–∏–º—É–º)"),
                QuestionOption("14-16_weeks", "14-16 —Ç–∏–∂–Ω—ñ–≤ (–¥–æ–≤–≥–∏–π)",
                             restrictions=["experienced_only"])
            ]
        )
        
        # –ö–û–†–ï–ö–¢–ò–í–ò: –ù–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ –¥–æ —ñ–Ω'—î–∫—Ü—ñ–π  
        questions["injection_readiness"] = Question(
            id="injection_readiness",
            text="–í–∞—à–∞ –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å —Ä–æ–±–∏—Ç–∏ —ñ–Ω'—î–∫—Ü—ñ—ó?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("no", "–ö–∞—Ç–µ–≥–æ—Ä–∏—á–Ω–æ –Ω—ñ", 
                             restrictions=["orals_only"],
                             warnings=["‚ùå –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–Ñ–¢–¨–°–Ø - —Ç—ñ–ª—å–∫–∏ —Ç–∞–±–ª–µ—Ç–∫–∏"]),
                QuestionOption("scared_help", "–°—Ç—Ä–∞—à–Ω–æ/–±—É–¥—É –ø—Ä–æ—Å–∏—Ç–∏ –∫–æ–≥–æ—Å—å —Ä–æ–±–∏—Ç–∏ —ñ–Ω'—î–∫—Ü—ñ—ó",
                             restrictions=["once_weekly"],
                             warnings=[
                                 "‚ùå –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–Ñ–¢–¨–°–Ø - –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω—ñ –≥–æ—Ä–º–æ–Ω–∏",
                                 "‚ö†Ô∏è –Ø–∫—â–æ 375-500–º–≥ —Ç–µ—Å—Ç –µ–Ω–∞–Ω—Ç–∞—Ç - –±—ñ–ª—å—à–∞ –∞—Ä–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è",
                                 "‚ö†Ô∏è –í—Å–µ –æ–¥–Ω–æ —Ç—Ä–µ–±–∞ —Å—Ç–∞–≤–∏—Ç–∏ –ø—Ä–æ–ø—ñ–æ–Ω–∞—Ç –Ω–∞ –≤–∏—Ö–æ–¥—ñ –∑ –∫—É—Ä—Å—É"
                             ]),
                QuestionOption("twice_weekly", "–ë–µ–∑ –ø—Ä–æ–±–ª–µ–º —ñ–Ω'—î–∫—Ü—ñ—ó –¥–≤–∞ —Ä–∞–∑–∏ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å –¥–æ–≤–≥–∏–º–∏ –µ—Ñ—ñ—Ä–∞–º–∏"),
                QuestionOption("comfortable", "–ù–æ—Ä–º–∞–ª—å–Ω–æ (—á–µ—Ä–µ–∑ –¥–µ–Ω—å)"),
                QuestionOption("daily", "–ë–µ–∑ –ø—Ä–æ–±–ª–µ–º (—â–æ–¥–Ω—è)")
            ]
        )
        
        # ===========================================
        # –ë–Æ–î–ñ–ï–¢
        # ===========================================
        
        questions["budget"] = Question(
            id="budget",
            text="–í–∞—à –±—é–¥–∂–µ—Ç –Ω–∞ –∫—É—Ä—Å? (–≤ –¥–æ–ª–∞—Ä–∞—Ö)",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("<50", "–î–æ $50 (–¥–æ 2100 –≥—Ä–Ω)"),
                QuestionOption("50-120", "$50-120 (2100-5000 –≥—Ä–Ω)"),
                QuestionOption("120-240", "$120-240 (5000-10000 –≥—Ä–Ω)"),
                QuestionOption(">240", "–ü–æ–Ω–∞–¥ $240 (10000+ –≥—Ä–Ω)"),
                QuestionOption("unlimited", "–ë—é–¥–∂–µ—Ç –Ω–µ –æ–±–º–µ–∂–µ–Ω–∏–π")
            ]
        )
        
        # –ö–û–†–ï–ö–¢–ò–í–ò: –§—ñ–Ω–∞–Ω—Å–æ–≤–∞ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å –∑–¥–∞–≤–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑–∏
        questions["lab_monitoring"] = Question(
            id="lab_monitoring", 
            text="–í–∞—à–∞ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∞ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å –∑–¥–∞–≤–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑–∏ –Ω–∞ –∫—É—Ä—Å—ñ?",
            type=QuestionType.SELECT,
            options=[
                QuestionOption("regular", "–ú–æ–∂—É –∑–¥–∞–≤–∞—Ç–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ",
                             follow_up="–ï—Å—Ç—Ä–∞–¥—ñ–æ–ª —á–µ—Ä–µ–∑ 10 –¥–Ω—ñ–≤ –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É –∫—É—Ä—Å—É, —â–æ–º—ñ—Å—è—á–Ω–æ –µ—Å—Ç—Ä–∞–¥—ñ–æ–ª + –ø—Ä–æ–ª–∞–∫—Ç–∏–Ω + –ó–ê–ö + –ª—ñ–ø—ñ–¥–æ–≥—Ä–∞–º–∞ –∑ –ª—ñ–ø–æ–ø—Ä–æ—Ç–µ—ó–¥–∞–º–∏ –Ω–∏–∑—å–∫–æ—ó —Ç–∞ –¥—É–∂–µ –Ω–∏–∑—å–∫–æ—ó —â—ñ–ª—å–Ω–æ—Å—Ç—ñ"),
                QuestionOption("limited", "–û–±–º–µ–∂–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø",
                             follow_up="–©–æ–º—ñ—Å—è—á–Ω–æ –µ—Å—Ç—Ä–∞–¥—ñ–æ–ª + –ø—Ä–æ–ª–∞–∫—Ç–∏–Ω + –ó–ê–ö + –ª—ñ–ø—ñ–¥–æ–≥—Ä–∞–º–∞ –∑ –ª—ñ–ø–æ–ø—Ä–æ—Ç–µ—ó–¥–∞–º–∏ –Ω–∏–∑—å–∫–æ—ó —Ç–∞ –¥—É–∂–µ –Ω–∏–∑—å–∫–æ—ó —â—ñ–ª—å–Ω–æ—Å—Ç—ñ —á–µ—Ä–µ–∑ 4-6 —Ç–∏–∂–Ω—ñ–≤ –ø—ñ—Å–ª—è –ø–æ—á–∞—Ç–∫—É –∫—É—Ä—Å—É –ø–æ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ"),
                QuestionOption("difficult", "–°–∫–ª–∞–¥–Ω–æ –∑–¥–∞–≤–∞—Ç–∏",
                             follow_up="–ü–æ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –∑ —Ü—å–æ–≥–æ —Å–ø–∏—Å–∫—É —Ä–∞–∑ –≤ –º—ñ—Å—è—Ü—å: –µ—Å—Ç—Ä–∞–¥—ñ–æ–ª + –ø—Ä–æ–ª–∞–∫—Ç–∏–Ω + –ó–ê–ö + –ª—ñ–ø—ñ–¥–æ–≥—Ä–∞–º–∞ –∑ –ª—ñ–ø–æ–ø—Ä–æ—Ç–µ—ó–¥–∞–º–∏ –Ω–∏–∑—å–∫–æ—ó —Ç–∞ –¥—É–∂–µ –Ω–∏–∑—å–∫–æ—ó —â—ñ–ª—å–Ω–æ—Å—Ç—ñ")
            ]
        )
        
        return questions
    
    def _build_question_flow(self) -> Dict[str, str]:
        """–ü–æ–±—É–¥–æ–≤–∞ –ø–æ—Ç–æ–∫—É –ø–∏—Ç–∞–Ω—å"""
        
        return {
            "start": "age",
            "age": "weight", 
            "weight": "height",
            "height": "cycle_count",
            "cycle_count": "previous_compounds",  # —É–º–æ–≤–Ω–æ
            "previous_compounds": "alopecia",
            "alopecia": "prostate",
            "prostate": "liver", 
            "liver": "joints",
            "joints": "blood_pressure",
            "blood_pressure": "atherosclerosis",  # —É–º–æ–≤–Ω–æ –¥–ª—è 38+
            "atherosclerosis": "main_goal",
            "main_goal": "sport_type",
            "sport_type": "duration",
            "duration": "injection_readiness",
            "injection_readiness": "budget",
            "budget": "lab_monitoring",
            "lab_monitoring": "end"
        }
    
    def get_first_question(self) -> Dict:
        """–û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–µ—Ä—à–æ–≥–æ –ø–∏—Ç–∞–Ω–Ω—è"""
        
        first_q_id = self.question_flow["start"]
        question = self.questions[first_q_id]
        
        return self._format_question(question)
    
    def get_next_question(self, current_question_id: str, answers: Dict) -> Optional[Dict]:
        """–û—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–Ω—è –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —É–º–æ–≤–Ω–æ—ó –ª–æ–≥—ñ–∫–∏"""
        
        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫
        next_id = self.question_flow.get(current_question_id)
        
        if not next_id or next_id == "end":
            return None
        
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–º–æ–≤–Ω–æ—ó –ª–æ–≥—ñ–∫–∏
        next_question = self.questions[next_id]
        
        # –ü—Ä–æ–ø—É—Å–∫ –ø–∏—Ç–∞–Ω–Ω—è —è–∫—â–æ –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å —É–º–æ–≤–∞
        if self._should_skip_question(next_question, answers):
            return self.get_next_question(next_id, answers)
        
        return self._format_question(next_question)
    
    def _should_skip_question(self, question: Question, answers: Dict) -> bool:
        """–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è"""
        
        if not question.conditional_logic:
            return False
        
        show_if = question.conditional_logic.get("show_if", {})
        
        for condition_key, required_values in show_if.items():
            user_answer = answers.get(condition_key)
            if user_answer not in required_values:
                return True
        
        return False
    
    def _format_question(self, question: Question) -> Dict:
        """–§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –ø–∏—Ç–∞–Ω–Ω—è –¥–ª—è API"""
        
        formatted = {
            "id": question.id,
            "text": question.text,
            "type": question.type.value,
            "required": question.required
        }
        
        if question.options:
            formatted["options"] = []
            for option in question.options:
                option_data = {
                    "value": option.value,
                    "label": option.label
                }
                
                if option.warnings:
                    option_data["warnings"] = option.warnings
                
                if option.follow_up:
                    option_data["follow_up"] = option.follow_up
                
                formatted["options"].append(option_data)
        
        return formatted
    
    def calculate_questionnaire_score(self, answers: Dict) -> Dict:
        """–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ —Å–∫–æ—Ä—É –∞–Ω–∫–µ—Ç–∏"""
        
        total_score = 0
        max_score = 0
        restrictions = []
        warnings = []
        
        for q_id, answer in answers.items():
            if q_id not in self.questions:
                continue
                
            question = self.questions[q_id]
            
            if question.options:
                for option in question.options:
                    if option.value == answer:
                        total_score += option.score
                        max_score += 3  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Å–∫–æ—Ä
                        
                        if option.restrictions:
                            restrictions.extend(option.restrictions)
                        
                        if option.warnings:
                            warnings.extend(option.warnings)
                        break
        
        safety_level = "high"
        if restrictions:
            safety_level = "medium"
        if any(r in restrictions for r in ["exclude_all_dht", "injectable_only", "consultation_mandatory"]):
            safety_level = "low"
        
        return {
            "total_score": total_score,
            "max_score": max_score,
            "percentage": round((total_score / max_score) * 100) if max_score > 0 else 0,
            "safety_level": safety_level,
            "restrictions": list(set(restrictions)),
            "warnings": list(set(warnings))
        }
    
    def get_question_by_id(self, question_id: str) -> Optional[Question]:
        """–û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–∏—Ç–∞–Ω–Ω—è –∑–∞ ID"""
        return self.questions.get(question_id)
    
    def validate_answer(self, question_id: str, answer: str) -> Dict:
        """–í–∞–ª—ñ–¥–∞—Ü—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ"""
        
        question = self.questions.get(question_id)
        if not question:
            return {"valid": False, "error": "–ü–∏—Ç–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"}
        
        if question.required and not answer:
            return {"valid": False, "error": "–í—ñ–¥–ø–æ–≤—ñ–¥—å –æ–±–æ–≤'—è–∑–∫–æ–≤–∞"}
        
        if question.options:
            valid_values = [opt.value for opt in question.options]
            if answer not in valid_values:
                return {"valid": False, "error": "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å"}
        
        return {"valid": True}
    
    def get_summary_for_ai(self, answers: Dict) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ä–µ–∑—é–º–µ –¥–ª—è AI –∞–Ω–∞–ª—ñ–∑—É"""
        
        summary = "üìä –†–µ–∑—é–º–µ –∞–Ω–∫–µ—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:\n\n"
        
        # –ë–∞–∑–æ–≤—ñ –¥–∞–Ω—ñ
        age = answers.get("age", "–Ω–µ–≤—ñ–¥–æ–º–æ")
        weight = answers.get("weight", "–Ω–µ–≤—ñ–¥–æ–º–æ") 
        experience = answers.get("cycle_count", "0")
        goal = answers.get("main_goal", "–Ω–µ–≤—ñ–¥–æ–º–æ")
        
        summary += f"üë§ –û—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ: {age} —Ä–æ–∫—ñ–≤, {weight} –∫–≥\n"
        summary += f"üí™ –î–æ—Å–≤—ñ–¥: {experience} –∫—É—Ä—Å—ñ–≤\n"
        summary += f"üéØ –¶—ñ–ª—å: {goal}\n\n"
        
        # –û–±–º–µ–∂–µ–Ω–Ω—è
        restrictions = []
        if answers.get("alopecia") in ["active", "mild"]:
            restrictions.append("–∞–ª–æ–ø–µ—Ü—ñ—è")
        if answers.get("blood_pressure") == "hypertension":
            restrictions.append("–≥—ñ–ø–µ—Ä—Ç–æ–Ω—ñ—è")
        if answers.get("injection_readiness") == "no":
            restrictions.append("—Ç—ñ–ª—å–∫–∏ —Ç–∞–±–ª–µ—Ç–∫–∏")
        
        if restrictions:
            summary += f"‚ö†Ô∏è –û–±–º–µ–∂–µ–Ω–Ω—è: {', '.join(restrictions)}\n"
        
        # –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ
        injection_pref = answers.get("injection_readiness", "–Ω–µ–≤—ñ–¥–æ–º–æ")
        budget = answers.get("budget", "–Ω–µ–≤—ñ–¥–æ–º–æ")
        monitoring = answers.get("lab_monitoring", "–Ω–µ–≤—ñ–¥–æ–º–æ")
        
        summary += f"üíâ –Ü–Ω'—î–∫—Ü—ñ—ó: {injection_pref}\n"
        summary += f"üí∞ –ë—é–¥–∂–µ—Ç: {budget}\n"
        summary += f"üî¨ –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥: {monitoring}\n"
        
        return summary
